
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compute Demo: ENSO nonlinearity index with CMIP6 data &#8212; My Jupyter Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Demo: Regridding and Plotting with Rooki and Cartopy" href="ex-regrid-plot.html" />
    <link rel="prev" title="Using intake-esgf with rooki" href="use-intake-esgf-with-rooki.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   ESGF Cookbook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preamble
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="how-to-cite.html">
   How to Cite This Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="running-on-nimbus.html">
   Running Notebooks on Nimbus
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Searching
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro-search.html">
   Introduction to
   <code class="docutils literal notranslate">
    <span class="pre">
     intake-esgf
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="complex-search.html">
   Complex Searching with
   <code class="docutils literal notranslate">
    <span class="pre">
     intake-esgf
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rooki.html">
   Compute Demo: Use Rooki to access CMIP6 data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="use-intake-esgf-with-rooki.html">
   Using intake-esgf with rooki
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Workflows
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Compute Demo: ENSO nonlinearity index with CMIP6 data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ex-regrid-plot.html">
   Demo: Regridding and Plotting with Rooki and Cartopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="complex-search2-and-analysis.html">
   Complex Searching with
   <code class="docutils literal notranslate">
    <span class="pre">
     intake
    </span>
   </code>
   and analysing employing
   <code class="docutils literal notranslate">
    <span class="pre">
     xarray
    </span>
   </code>
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/rooki_enso_nonlinear.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retrieve-subset-of-cmip6-data">
   Retrieve subset of CMIP6 data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subset-and-regrid-the-data">
   Subset and regrid the data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#enso-nonlinearity-measure-alpha-value">
   ENSO nonlinearity measure:
   <code class="docutils literal notranslate">
    <span class="pre">
     alpha
    </span>
   </code>
   value
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-the-results">
   Plot the results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resources">
   Resources
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Compute Demo: ENSO nonlinearity index with CMIP6 data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retrieve-subset-of-cmip6-data">
   Retrieve subset of CMIP6 data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subset-and-regrid-the-data">
   Subset and regrid the data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#enso-nonlinearity-measure-alpha-value">
   ENSO nonlinearity measure:
   <code class="docutils literal notranslate">
    <span class="pre">
     alpha
    </span>
   </code>
   value
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-the-results">
   Plot the results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resources">
   Resources
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="compute-demo-enso-nonlinearity-index-with-cmip6-data">
<h1>Compute Demo: ENSO nonlinearity index with CMIP6 data<a class="headerlink" href="#compute-demo-enso-nonlinearity-index-with-cmip6-data" title="Permalink to this headline">¶</a></h1>
<p><img src="images/alpha_output.png" width=550 alt="Alpha output"></img></p>
<hr class="docutils" />
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In this demo we combine multiple multiple tools described in previous cookbooks to subset, regrid and process CMIP6 data. We will be computing a measure of ENSO nonlinearity by computing the EOFs of the pacific sea surface temperature anomalies. This measure is particularly useful for characterizing models by their ability to represent different ENSO extremes (Karamperidou et al., 2017).</p>
<p>The process we are going to follow in this demo is:</p>
<ol class="arabic simple">
<li><p>Find the CMIP6 data we need using intake-esgf</p></li>
<li><p>Subset the data and regrid it to a common grid using Rooki</p></li>
<li><p>Load the datasets into xarray and perform the computations</p></li>
<li><p>Plot the results</p></li>
</ol>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Concepts</p></th>
<th class="head"><p>Importance</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://foundations.projectpythia.org/core/xarray/xarray-intro.html">Intro to Xarray</a></p></td>
<td><p>Necessary</p></td>
<td><p>How to use xarray to work with NetCDF data</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="intro-search.html"><span class="doc std std-doc">Intro to Intake-ESGF</span></a></p></td>
<td><p>Necessary</p></td>
<td><p>How to configure a search and use output</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="rooki.html"><span class="doc std std-doc">Intro to Rooki</span></a></p></td>
<td><p>Helpful</p></td>
<td><p>How to initialize and run rooki</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://projectpythia.org/eofs-cookbook/notebooks/eof-intro.html">Intro to EOFs</a></p></td>
<td><p>Helpful</p></td>
<td><p>Understanding of EOFs</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Time to learn</strong>: 20 minutes</p></li>
</ul>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">intake_esgf</span>

<span class="c1"># Run this on the DKRZ node in Germany, using the ESGF1 index node at LLNL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ROOK_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://rook.dkrz.de/wps&quot;</span>
<span class="n">intake_esgf</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anl-dev&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="s2">&quot;ornl-dev&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="s2">&quot;esgf-node.llnl.gov&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.polynomial.polynomial</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">poly</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xeofs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">intake_esgf</span><span class="w"> </span><span class="kn">import</span> <span class="n">ESGFCatalog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rooki</span><span class="w"> </span><span class="kn">import</span> <span class="n">operators</span> <span class="k">as</span> <span class="n">ops</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rooki</span><span class="w"> </span><span class="kn">import</span> <span class="n">rooki</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="retrieve-subset-of-cmip6-data">
<h2>Retrieve subset of CMIP6 data<a class="headerlink" href="#retrieve-subset-of-cmip6-data" title="Permalink to this headline">¶</a></h2>
<p>The CMIP6 dataset is identified by a dataset-id. Using intake-esgf we can query the ESGF database for the variables and models we are interested in. For this demo we are interested in the tos (sea surface temperature) variable for the historical runs. Also, for sake of simplicity we will only query a subset of the models available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">=</span> <span class="n">ESGFCatalog</span><span class="p">()</span>
<span class="n">cat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="n">experiment_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;historical&quot;</span><span class="p">],</span>
    <span class="n">variable_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tos&quot;</span><span class="p">],</span>
    <span class="n">table_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Omon&quot;</span><span class="p">],</span>
    <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">],</span>
    <span class="n">grid_label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gn&quot;</span><span class="p">],</span>
    <span class="n">source_id</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;CAMS-CSM1-0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FGOALS-g3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CMCC-CM2-SR5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CNRM-CM6-1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CNRM-ESM2-1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CESM2&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="n">cat</span><span class="o">.</span><span class="n">remove_ensembles</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "61317ce0fa9743e4a03dd83650b6d9f0"}</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IndexError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/multiprocessing/pool.py:856,</span> in <span class="ni">IMapIterator.next</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">855</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">856</span>     <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">857</span> <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>

<span class="ne">IndexError</span>: pop from an empty deque

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">ESGFCatalog</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">cat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">experiment_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;historical&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">variable_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tos&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">table_id</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Omon&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">grid_label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gn&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">source_id</span><span class="o">=</span><span class="p">[</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>         <span class="s2">&quot;CAMS-CSM1-0&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>         <span class="s2">&quot;FGOALS-g3&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>         <span class="s2">&quot;CMCC-CM2-SR5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>         <span class="s2">&quot;CNRM-CM6-1&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>         <span class="s2">&quot;CNRM-ESM2-1&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>         <span class="s2">&quot;CESM2&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">cat</span><span class="o">.</span><span class="n">remove_ensembles</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/intake_esgf/catalog.py:354,</span> in <span class="ni">ESGFCatalog.search</span><span class="nt">(self, quiet, file_start, file_end, **search)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span> <span class="n">search_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span> <span class="n">dfs</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">))</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">_search</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">354</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">combine_results</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>     <span class="n">tqdm</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>         <span class="n">dfs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span>         <span class="n">disable</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span>         <span class="n">bar_format</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">bar_format</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">359</span>         <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">360</span>         <span class="n">unit_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">361</span>         <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Searching indices&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">362</span>         <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">363</span>         <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">364</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">365</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">366</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_project</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">368</span> <span class="c1"># even though we are using latest=True, because the search is distributed, we</span>
<span class="g g-Whitespace">    </span><span class="mi">369</span> <span class="c1"># may have different versions from different indices.</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/intake_esgf/base.py:245,</span> in <span class="ni">combine_results</span><span class="nt">(dfs)</span>
<span class="g g-Whitespace">    </span><span class="mi">243</span> <span class="c1"># combine and remove duplicate entries</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">intake_esgf</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">245</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span>     <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[36;32msearch end </span><span class="se">\x1b</span><span class="s2">[91;20mno results</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/pandas/core/reshape/concat.py:382,</span> in <span class="ni">concat</span><span class="nt">(objs, axis, join, ignore_index, keys, levels, names, verify_integrity, sort, copy)</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span> <span class="k">elif</span> <span class="n">copy</span> <span class="ow">and</span> <span class="n">using_copy_on_write</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span>     <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span>
<span class="ne">--&gt; </span><span class="mi">382</span> <span class="n">op</span> <span class="o">=</span> <span class="n">_Concatenator</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span>     <span class="n">objs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span>     <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span>     <span class="n">ignore_index</span><span class="o">=</span><span class="n">ignore_index</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>     <span class="n">join</span><span class="o">=</span><span class="n">join</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">387</span>     <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">388</span>     <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>     <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>     <span class="n">verify_integrity</span><span class="o">=</span><span class="n">verify_integrity</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">391</span>     <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">392</span>     <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">393</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">395</span> <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/pandas/core/reshape/concat.py:445,</span> in <span class="ni">_Concatenator.__init__</span><span class="nt">(self, objs, axis, join, keys, levels, names, ignore_index, verify_integrity, copy, sort)</span>
<span class="g g-Whitespace">    </span><span class="mi">442</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_integrity</span> <span class="o">=</span> <span class="n">verify_integrity</span>
<span class="g g-Whitespace">    </span><span class="mi">443</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy</span>
<span class="ne">--&gt; </span><span class="mi">445</span> <span class="n">objs</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_keys_and_objs</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">447</span> <span class="c1"># figure out what our result ndim is going to be</span>
<span class="g g-Whitespace">    </span><span class="mi">448</span> <span class="n">ndims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ndims</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/pandas/core/reshape/concat.py:504,</span> in <span class="ni">_Concatenator._clean_keys_and_objs</span><span class="nt">(self, objs, keys)</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span>     <span class="n">objs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">objs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">504</span>     <span class="n">objs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">506</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">507</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No objects to concatenate&quot;</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/tqdm/notebook.py:250,</span> in <span class="ni">tqdm_notebook.__iter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>     <span class="n">it</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="c1"># return super(tqdm...) will not catch exception</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="k">yield</span> <span class="n">obj</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span> <span class="c1"># NB: except ... [ as ...] breaks IPython async KeyboardInterrupt</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/site-packages/tqdm/std.py:1181,</span> in <span class="ni">tqdm.__iter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1178</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>
<span class="g g-Whitespace">   </span><span class="mi">1180</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1181</span>     <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1182</span>         <span class="k">yield</span> <span class="n">obj</span>
<span class="g g-Whitespace">   </span><span class="mi">1183</span>         <span class="c1"># Update and possibly print the progressbar.</span>
<span class="g g-Whitespace">   </span><span class="mi">1184</span>         <span class="c1"># Note: does not call self.update(1) for speed optimisation.</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/multiprocessing/pool.py:861,</span> in <span class="ni">IMapIterator.next</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span>     <span class="k">raise</span> <span class="ne">StopIteration</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">861</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">862</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">863</span>     <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

<span class="nn">File ~/micromamba/envs/esgf-cookbook-dev/lib/python3.11/threading.py:327,</span> in <span class="ni">Condition.wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="k">try</span><span class="p">:</span>    <span class="c1"># restore state no matter what (e.g., KeyboardInterrupt)</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">327</span>         <span class="n">waiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">328</span>         <span class="n">gotit</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span>     <span class="k">else</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>Once the catalog has been queried, we have to do some manipulation in pandas to keep only the dataset_id. This has to be done because the same data has multiple locations online, and these get appended at the end of the dataset_id. Rookie only accepts the dataset_id without the online location, so we get rid of it in the next step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">keep_ds_id</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collections</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">keep_ds_id</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">collections</span>
</pre></div>
</div>
</div>
</div>
<p>We are left with a list of dataset_ids that Rookie can accept as input for the next step.</p>
</div>
<div class="section" id="subset-and-regrid-the-data">
<h2>Subset and regrid the data<a class="headerlink" href="#subset-and-regrid-the-data" title="Permalink to this headline">¶</a></h2>
<p>We define a function that will do the subset and regridding for us for each of the dataset_ids we have. The function will take the dataset_id as input and then use Rookie functions to select 100 years of data for the tos variable in the Pacific Ocean region. We don’t need high resolution data for this particular use, so 2.5 degree resolution is enough.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_pacific_ocean</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">):</span>
    <span class="n">wf</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Regrid</span><span class="p">(</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="s2">&quot;tos&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">dataset_id</span><span class="p">]),</span>
            <span class="n">time</span><span class="o">=</span><span class="s2">&quot;1900-01-01/2000-01-31&quot;</span><span class="p">,</span>
            <span class="n">area</span><span class="o">=</span><span class="s2">&quot;100,-20,280,20&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest_s2d&quot;</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="s2">&quot;2pt5deg&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">orchestrate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">size_in_mb</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">datasets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sst_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">dset</span><span class="p">:</span> <span class="n">get_pacific_ocean</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="enso-nonlinearity-measure-alpha-value">
<h2>ENSO nonlinearity measure: <code class="docutils literal notranslate"><span class="pre">alpha</span></code> value<a class="headerlink" href="#enso-nonlinearity-measure-alpha-value" title="Permalink to this headline">¶</a></h2>
<p>This part of the demo is computation heavy. You can refer to Takahashi et al. (2011) and Karamperidou et al. (2017) for more details on the usefulness and computation of the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter is computed by doing a quadratic fit to the first two EOFs for the DJF season of the SST anomalies in the Pacific region. We are looking to obtain two EOFs modes that represent the Eastern and central pacific SST patterns, which is why we include a correction factor to account for the fact the sometimes the EOFs come with the opposite sign.</p>
<p>The higher the value of <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, the more nonlinear (or extreme) ENSO events can be represented by the model. Likewise, a model with lower <code class="docutils literal notranslate"><span class="pre">alpha</span></code> values will have a harder time representing extreme ENSO events, making it not suitable for climate studies of ENSO in a warming climate (Cai et al., 2018, 2021).</p>
<p>We are looking to obtain data that can reproduce a figure similar to the one below (taken from Karamperiou et al., 2017):</p>
<p><img src="images/alpha_example.png" alt="Alpha parameter" style="width: 600px"></img></p>
<p>Each of the “wings” of this boomerang-shaped distribution represents a different ENSO extreme, with the left (right) wing representing the extreme central (eastern) pacific El Niño events. More details on Takahashi et al. (2011).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_alpha</span><span class="p">(</span><span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">):</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pc1</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">pc1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span> <span class="n">coefs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xfit</span><span class="p">,</span> <span class="n">fit</span>


<span class="k">def</span><span class="w"> </span><span class="nf">correction_factor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">_eofs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">components</span><span class="p">()</span>
    <span class="n">_subset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
    <span class="n">corr_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">corr_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">_eofs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">_subset</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">corr_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">_eofs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">_subset</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">corr_factor</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_index</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">tos</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">tos</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">280</span><span class="p">))</span>
    <span class="n">tos_anom</span> <span class="o">=</span> <span class="n">tos</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">))</span>

    <span class="c1"># Compute Eofs</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tos_anom</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">corr_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># eofs = s_model.components()</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">singular_values</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">explained_variance</span><span class="p">())</span>
    <span class="n">pcs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">scale_factor</span>
        <span class="o">*</span> <span class="n">corr_factor</span>
    <span class="p">)</span>

    <span class="n">pc1</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pc1</span> <span class="o">=</span> <span class="n">pc1</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">pc1</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="n">pc1</span> <span class="o">=</span> <span class="n">pc1</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;QS-DEC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="n">pc2</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pc2</span> <span class="o">=</span> <span class="n">pc2</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">pc2</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="n">pc2</span> <span class="o">=</span> <span class="n">pc2</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;QS-DEC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="n">alpha</span><span class="p">,</span> <span class="n">xfit</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">xfit</span><span class="p">,</span> <span class="n">fit</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can compute the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter for each of the models we have selected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_fits</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sst_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">alpha_fits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-results">
<h2>Plot the results<a class="headerlink" href="#plot-the-results" title="Permalink to this headline">¶</a></h2>
<p>Finally, we can plot the results of the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter for each of the models we have selected. This will give us an idea of how well the models represent different ENSO extremes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">(</span><span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">xfit</span><span class="p">,</span> <span class="n">fit</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alpha_fits</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># draw a line 45 degrees</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">pc1</span><span class="p">,</span>
        <span class="n">pc2</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">alpha=$</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From this example, we can see that from the subset of models we have selected, the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter is higher for CMCC-CM2-SR5 compared to the other models as the “boomerang” shape is better represented in this model. This indicates that this model is better at representing extreme ENSO events compared to the other models.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, we used intake-esgf with Rooki Python client to retrieve a subset of a CMIP6 dataset. The subset and regrid operations are executed remotely on a Rook subsetting service (using OGC API and xarray/clisops). The dataset is analyzed using xeofs to extract a measurement used in ENSO research. We also showed that remote operators can be chained to be executed in a single workflow operation.</p>
</div>
<div class="section" id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/roocs">Roocs on GitHub</a></p></li>
<li><p><a class="reference external" href="https://cds.climate.copernicus.eu/">Copernicus Climate Data Store</a></p></li>
<li><p><a class="reference external" href="https://stacspec.org/en">STAC</a></p></li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Cai, W., Santoso, A., Collins, M., Dewitte, B., Karamperidou, C., Kug, J.-S., Lengaigne, M., McPhaden, M. J., Stuecker, M. F., Taschetto, A. S., Timmermann, A., Wu, L., Yeh, S.-W., Wang, G., Ng, B., Jia, F., Yang, Y., Ying, J., Zheng, X.-T., … Zhong, W. (2021). Changing El Niño–Southern Oscillation in a warming climate. Nature Reviews Earth &amp; Environment, 2(9), 628–644. <a class="reference external" href="https://doi.org/10.1038/s43017-021-00199-z">https://doi.org/10.1038/s43017-021-00199-z</a></p></li>
<li><p>Cai, W., Wang, G., Dewitte, B., Wu, L., Santoso, A., Takahashi, K., Yang, Y., Carréric, A., &amp; McPhaden, M. J. (2018). Increased variability of eastern Pacific El Niño under greenhouse warming. Nature, 564(7735), 201–206. <a class="reference external" href="https://doi.org/10.1038/s41586-018-0776-9">https://doi.org/10.1038/s41586-018-0776-9</a></p></li>
<li><p>Karamperidou, C., Jin, F.-F., &amp; Conroy, J. L. (2017). The importance of ENSO nonlinearities in tropical pacific response to external forcing. Climate Dynamics, 49(7), 2695–2704. <a class="reference external" href="https://doi.org/10.1007/s00382-016-3475-y">https://doi.org/10.1007/s00382-016-3475-y</a></p></li>
<li><p>Takahashi, K., Montecinos, A., Goubanova, K., &amp; Dewitte, B. (2011). ENSO regimes: Reinterpreting the canonical and Modoki El Niño. Geophysical Research Letters, 38(10). <a class="reference external" href="https://doi.org/10.1029/2011GL047364">https://doi.org/10.1029/2011GL047364</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="use-intake-esgf-with-rooki.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Using intake-esgf with rooki</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="ex-regrid-plot.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Demo: Regridding and Plotting with Rooki and Cartopy</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The Jupyter Book community<br/>
    
        &copy; Copyright 2023.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>